<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Browser Debug MCP Bridge</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <h1>Browser Debug MCP Bridge</h1>
    <div id="status" class="status">Loading...</div>
    <div class="session-meta">
      <div><strong>Session:</strong> <span id="session-id">-</span></div>
      <div><strong>Queue:</strong> <span id="queue-size">0</span></div>
      <div><strong>Dropped:</strong> <span id="dropped-events">0</span></div>
    </div>
    <div class="controls">
      <button id="start-session" type="button">Start Session</button>
      <button id="stop-session" type="button">Stop Session</button>
    </div>
    <button id="show-db-entries" type="button">Open DB entries</button>
    <div class="settings">
      <label class="toggle" for="safe-mode">
        <input id="safe-mode" type="checkbox">
        <span>Safe mode</span>
      </label>
      <label class="allowlist" for="allowlist-domains">Domain allowlist</label>
      <textarea id="allowlist-domains" rows="4" placeholder="example.com&#10;*.staging.example.com"></textarea>

      <details class="snapshot-settings" open>
        <summary>Snapshot capture</summary>
        <label class="toggle" for="snapshots-enabled">
          <input id="snapshots-enabled" type="checkbox">
          <span>Enable snapshots (manual)</span>
        </label>
        <label class="toggle" for="snapshots-opt-in">
          <input id="snapshots-opt-in" type="checkbox" checked>
          <span>Require LLM request opt-in</span>
        </label>

        <label for="snapshot-mode">Snapshot mode</label>
        <select id="snapshot-mode">
          <option value="dom" selected>DOM only (default)</option>
          <option value="png">PNG only</option>
          <option value="both">DOM + PNG</option>
        </select>

        <label for="snapshot-style-mode">Style mode</label>
        <select id="snapshot-style-mode">
          <option value="computed-lite" selected>computed-lite (default)</option>
          <option value="computed-full">computed-full (explicit)</option>
        </select>

        <div class="snapshot-triggers">
          <span class="allowlist">Triggers</span>
          <label class="toggle" for="snapshot-trigger-click">
            <input id="snapshot-trigger-click" type="checkbox" checked>
            <span>click</span>
          </label>
          <label class="toggle" for="snapshot-trigger-manual">
            <input id="snapshot-trigger-manual" type="checkbox" checked>
            <span>manual</span>
          </label>
          <label class="toggle" for="snapshot-trigger-navigation">
            <input id="snapshot-trigger-navigation" type="checkbox">
            <span>navigation</span>
          </label>
          <label class="toggle" for="snapshot-trigger-error">
            <input id="snapshot-trigger-error" type="checkbox">
            <span>error</span>
          </label>
        </div>

        <div class="snapshot-policy-grid">
          <label for="snapshot-max-images">Max images/session</label>
          <input id="snapshot-max-images" type="number" min="0" step="1" value="8">

          <label for="snapshot-max-bytes">Max bytes/image</label>
          <input id="snapshot-max-bytes" type="number" min="32768" step="1024" value="262144">

          <label for="snapshot-min-interval">Min interval (ms)</label>
          <input id="snapshot-min-interval" type="number" min="250" step="50" value="5000">
        </div>
      </details>

      <button id="save-config" type="button">Save Settings</button>
      <div id="config-status" class="config-status"></div>
    </div>
    <details class="settings retention-settings">
      <summary>Data retention</summary>
      <label for="retention-days">Keep sessions (days)</label>
      <input id="retention-days" type="number" min="1" step="1" value="30">

      <label for="max-db-mb">Max DB size (MB)</label>
      <input id="max-db-mb" type="number" min="50" step="1" value="1024">

      <label for="max-sessions">Max sessions</label>
      <input id="max-sessions" type="number" min="100" step="1" value="10000">

      <label for="export-path">Export path override (optional)</label>
      <input id="export-path" type="text" placeholder="C:\\path\\to\\exports">

      <div class="controls retention-actions">
        <button id="save-retention" type="button">Save retention <span class="hint" title="Save retention settings to the server." aria-label="Save retention help">!</span></button>
        <button id="run-cleanup-now" type="button">Run cleanup now <span class="hint" title="Immediately remove old sessions using current limits." aria-label="Run cleanup help">!</span></button>
      </div>

      <div class="controls retention-actions">
        <button id="pin-session" type="button">Pin session <span class="hint" title="Protect current session from automatic cleanup." aria-label="Pin session help">!</span></button>
        <button id="unpin-session" type="button">Unpin session <span class="hint" title="Allow current session to be removed by retention cleanup." aria-label="Unpin session help">!</span></button>
      </div>
      <button id="export-session" type="button">Export current session <span class="hint" title="Export current session as zip package with snapshots." aria-label="Export session help">!</span></button>
      <label for="import-session-file">Import session (zip/json)</label>
      <input id="import-session-file" type="file" accept=".zip,.json,application/json,application/zip">
      <button id="import-session" type="button">Import session <span class="hint" title="Load an exported zip/json session into local DB for inspection." aria-label="Import session help">!</span></button>
      <div id="cleanup-info" class="config-status"></div>
      <div id="retention-status" class="config-status"></div>
    </details>

    <details class="settings danger-zone">
      <summary>Danger Zone</summary>
      <div class="danger-warning">
        <strong>Warning:</strong> These actions cannot be undone.
      </div>
      <div class="danger-actions">
        <button id="reset-db" type="button" class="danger-button">Reset Database</button>
      </div>
      <div id="reset-db-status" class="config-status"></div>
      <dialog id="reset-confirm-modal" class="danger-modal">
        <div class="danger-modal-content">
          <h3>Reset Database?</h3>
          <p>This will permanently delete <strong>ALL sessions, events, and network data</strong> from the database.</p>
          <p>This action cannot be undone.</p>
          <div class="danger-modal-actions">
            <button id="reset-confirm-cancel" type="button">Cancel</button>
            <button id="reset-confirm-yes" type="button" class="danger-button">Yes, Reset Everything</button>
          </div>
        </div>
      </dialog>
    </details>
  </div>

  <dialog id="db-entries-modal" class="db-modal">
    <div class="db-modal-header">
      <h2>Session DB entries</h2>
      <button id="close-db-entries" type="button">Close</button>
    </div>
    <div class="db-modal-subtitle">Session: <span id="db-entries-session-id">-</span></div>
    <div id="db-entries-status" class="config-status"></div>
    <div class="db-filter-bar" role="group" aria-label="Entry filter">
      <button id="db-filter-all" class="db-filter-btn is-active" type="button" data-db-filter="all">All</button>
      <button id="db-filter-events" class="db-filter-btn" type="button" data-db-filter="event">Events</button>
      <button id="db-filter-network" class="db-filter-btn" type="button" data-db-filter="network">Network</button>
    </div>
    <div class="db-table-wrap">
      <table class="db-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Source</th>
            <th>Kind</th>
            <th>Summary</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="db-entries-body"></tbody>
      </table>
    </div>
    <div class="controls db-modal-actions">
      <button id="load-more-db-entries" type="button">Load more</button>
    </div>
  </dialog>
  <script type="module" src="popup.js"></script>
</body>
</html>
