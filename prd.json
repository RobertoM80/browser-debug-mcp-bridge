[
  {
    "category": "setup",
    "description": "Initialize git repository and Nx monorepo workspace with pnpm",
    "steps": [
      "Run git init to initialize repository",
      "Run pnpm init to create package.json with private: true",
      "Install Nx globally and create workspace: pnpm dlx create-nx-workspace@latest --preset=ts --pm=pnpm",
      "Configure pnpm-workspace.yaml with apps/* and libs/* patterns",
      "Create root tsconfig.base.json with strict TypeScript settings"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Create Nx project structure for mcp-server app",
    "steps": [
      "Create apps/mcp-server directory structure with src/ folder",
      "Create project.json with build, lint, test, and serve targets",
      "Create tsconfig.app.json and tsconfig.spec.json extending base",
      "Add minimal src/main.ts entry point with Fastify server stub",
      "Verify nx build mcp-server and nx serve mcp-server work"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Create Nx project structure for chrome-extension app",
    "steps": [
      "Create apps/chrome-extension directory with src/ and public/ folders",
      "Create project.json with build, lint, test, and pack targets",
      "Set up Vite configuration for MV3 extension build",
      "Create manifest.json in public/ with MV3 permissions",
      "Add stub content script, injected script, and background service worker",
      "Verify nx build chrome-extension produces installable output"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Create shared library packages",
    "steps": [
      "Create libs/shared with common types, schemas, and utilities",
      "Create libs/redaction with token/PII redaction logic",
      "Create libs/selectors with DOM selector generation utilities",
      "Create libs/mcp-contracts with MCP tool definitions and Zod schemas",
      "Configure all libs with proper project.json and tsconfig files",
      "Verify builds pass for all libraries"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Set up testing infrastructure with Vitest",
    "steps": [
      "Install vitest and @vitest/coverage-v8 as dev dependencies",
      "Create vitest.config.ts at root with shared configuration",
      "Add vitest configs for each app and lib",
      "Create example test files to verify test runner works",
      "Verify pnpm nx run-many -t test runs all tests"
    ],
    "passes": true
  },
  {
    "category": "domain core",
    "description": "Implement SQLite database schema and connection",
    "steps": [
      "Install better-sqlite3 dependency in mcp-server",
      "Create database schema: sessions, events, network, error_fingerprints tables",
      "Implement database initialization and migration utilities",
      "Create database connection singleton with proper typing",
      "Write unit tests for database operations"
    ],
    "passes": true
  },
  {
    "category": "domain core",
    "description": "Implement WebSocket server for event ingestion",
    "steps": [
      "Install ws dependency for WebSocket support",
      "Create WebSocket server integrated with Fastify",
      "Implement message parsing and validation with Zod",
      "Add connection management and health ping/pong",
      "Write integration tests for WS event ingestion"
    ],
    "passes": true
  },
  {
    "category": "domain core",
    "description": "Implement session management in extension",
    "steps": [
      "Create session state management in background service worker",
      "Implement start/stop session with sessionId generation",
      "Add WebSocket connection to local server from extension",
      "Create buffering and backpressure handling for events",
      "Add extension popup UI for session control"
    ],
    "passes": true
  },
  {
    "category": "domain core",
    "description": "Capture navigation and console events",
    "steps": [
      "Implement navigation event capture in content script",
      "Hook console methods (error, warn) in injected script",
      "Capture runtime errors via window.onerror and unhandledrejection",
      "Send events through background worker to server",
      "Verify events are persisted to SQLite database"
    ],
    "passes": true
  },
  {
    "category": "domain utilities",
    "description": "Implement redaction engine for sensitive data",
    "steps": [
      "Create redaction patterns for Authorization headers, JWTs, tokens",
      "Implement redaction utility with configurable rules",
      "Add redaction to all outgoing events from extension",
      "Add redactionSummary to all MCP tool responses",
      "Write unit tests for redaction patterns"
    ],
    "passes": true
  },
  {
    "category": "domain utilities",
    "description": "Implement domain allowlist and safe mode controls",
    "steps": [
      "Create allowlist configuration storage in extension",
      "Implement domain matching logic for capture decisions",
      "Add safe mode toggle in extension popup",
      "Enforce safe mode restrictions (no cookies, no storage, no input values)",
      "Write tests for allowlist and safe mode logic"
    ],
    "passes": true
  },
  {
    "category": "domain utilities",
    "description": "Implement robust selector generation",
    "steps": [
      "Create selector generation from DOM elements",
      "Support multiple strategies: id, class, data attributes, CSS path",
      "Handle dynamic classes and unstable selectors",
      "Add selector utilities to libs/selectors",
      "Write unit tests for selector generation"
    ],
    "passes": true
  },
  {
    "category": "data/persistence",
    "description": "Capture network request metadata",
    "steps": [
      "Hook fetch and XHR in injected script",
      "Capture method, URL, status, duration, initiator for each request",
      "Classify errors: timeout, cors, dns, blocked, http_error",
      "Store network metadata in database (no body capture)",
      "Verify network events are queryable via MCP tools"
    ],
    "passes": true
  },
  {
    "category": "data/persistence",
    "description": "Implement error fingerprinting and aggregation",
    "steps": [
      "Create error fingerprinting algorithm (message + stack hash)",
      "Aggregate errors by fingerprint in database",
      "Store count, sample message, and sample stack per fingerprint",
      "Update error_fingerprints table on new errors",
      "Write tests for fingerprinting logic"
    ],
    "passes": true
  },
  {
    "category": "data/persistence",
    "description": "Capture minimal user journey events",
    "steps": [
      "Capture click events with target selector (no typed text)",
      "Store event type, selector, and timestamp",
      "Avoid capturing sensitive input values",
      "Send user events to server via WebSocket",
      "Verify user journey events are persisted"
    ],
    "passes": true
  },
  {
    "category": "MCP tools",
    "description": "Implement MCP server foundation",
    "steps": [
      "Install @modelcontextprotocol/sdk dependency",
      "Create MCP server with stdio transport",
      "Implement tool registration and routing",
      "Add common response contract (limitsApplied, redactionSummary, sessionId)",
      "Write tests for MCP server initialization"
    ],
    "passes": true
  },
  {
    "category": "MCP tools",
    "description": "Implement V1 MCP query tools",
    "steps": [
      "Implement list_sessions tool with sinceMinutes filter",
      "Implement get_session_summary with counts and timeRange",
      "Implement get_recent_events with type filtering",
      "Implement get_navigation_history tool",
      "Implement get_console_events with level filtering",
      "Write integration tests for all V1 tools"
    ],
    "passes": true
  },
  {
    "category": "MCP tools",
    "description": "Implement error and network query tools",
    "steps": [
      "Implement get_error_fingerprints tool",
      "Implement get_network_failures with grouping options",
      "Implement get_element_refs tool",
      "Add proper limits and pagination to all query tools",
      "Write tests for error and network query tools"
    ],
    "passes": true
  },
  {
    "category": "MCP tools",
    "description": "Implement heavy capture on-demand (V2)",
    "steps": [
      "Create server-to-extension command protocol via WebSocket",
      "Implement get_dom_subtree tool with maxBytes and maxDepth limits",
      "Implement get_dom_document with outline and html modes",
      "Implement get_computed_styles for specific properties",
      "Implement get_layout_metrics with bounding boxes",
      "Add strict limits, timeouts, and fallback to outline mode"
    ],
    "passes": true
  },
  {
    "category": "MCP tools",
    "description": "Implement correlation engine tools (V3)",
    "steps": [
      "Implement time-window correlation algorithm",
      "Create explain_last_failure tool with reasoned timeline",
      "Implement get_event_correlation for linking related events",
      "Connect user actions to network failures and errors",
      "Write integration tests for correlation logic"
    ],
    "passes": true
  },
  {
    "category": "UI flows",
    "description": "Create extension popup UI",
    "steps": [
      "Build popup HTML with session controls",
      "Add connection status indicator",
      "Implement safe mode toggle",
      "Add domain allowlist input",
      "Style popup with minimal CSS"
    ],
    "passes": true
  },
  {
    "category": "UI flows",
    "description": "Add health and debugging endpoints",
    "steps": [
      "Implement GET /health endpoint with DB status",
      "Implement GET /stats endpoint for dev debugging",
      "Add structured logging for WS connections and MCP calls",
      "Create log prefixes for extension-side debugging",
      "Verify endpoints return correct data"
    ],
    "passes": true
  },
  {
    "category": "testing/verification",
    "description": "Create integration test suite for end-to-end flow",
    "steps": [
      "Set up test harness for WebSocket event streaming",
      "Create mocked event stream tests",
      "Test MCP tool responses for limits, redaction, and correctness",
      "Add test coverage for heavy capture commands",
      "Ensure all critical paths have test coverage"
    ],
    "passes": true
  },
  {
    "category": "performance/polish",
    "description": "Optimize event buffering and backpressure",
    "steps": [
      "Implement efficient event batching in extension",
      "Add backpressure handling when server is slow",
      "Track dropped events and log warnings",
      "Optimize database writes with batching",
      "Measure and document performance characteristics"
    ],
    "passes": true
  },
  {
    "category": "performance/polish",
    "description": "Create documentation and usage guides",
    "steps": [
      "Write README.md with installation and setup instructions",
      "Document MCP tools with examples",
      "Create SECURITY.md with privacy controls explained",
      "Add troubleshooting guide",
      "Document architecture decisions"
    ],
    "passes": true
  },
  {
    "category": "performance/polish",
    "description": "Build full and comprehensive documentation platform with Docusaurus using a GitHub Docs-style structure",
    "steps": [
      "Initialize a Docusaurus docs site (latest stable) in the Nx workspace and add targets for dev, build, and lint",
      "Define a GitHub Docs-style information architecture with clear top-level categories and deep, predictable sidebar hierarchy",
      "Create core sections: Getting Started, Architecture, MCP Tools, Extension, Server, Security & Privacy, Testing, Troubleshooting, FAQ, and Contributing",
      "Migrate and expand existing documentation from PROJECT_INFOS.md and docs/* into structured Docusaurus pages with cross-links and consistent terminology",
      "Add documentation features: autogenerated sidebars, full-text search, versioning strategy, and reusable MDX components for notes, warnings, and limits",
      "Write practical guides and workflows for local setup, debugging sessions, MCP tool usage, and failure diagnosis playbooks",
      "Create complete MCP tool reference pages with request/response schemas, limits, redaction behavior, and realistic examples",
      "Add documentation quality gates including link checking, markdown linting, and CI docs build verification",
      "Apply production-grade navigation and theming polish while staying consistent with project branding and readability goals",
      "Document contribution workflow for docs: authoring standards, templates, review checklist, and release update process"
    ],
    "passes": true
  },
  {
    "category": "UI flows",
    "description": "Add snapshot capture controls with opt-in policy and recommended defaults",
    "owner": "extension",
    "priority": "high",
    "steps": [
      "Add extension settings for snapshot capture with manual toggle and LLM-request opt-in gate.",
      "Add snapshot mode selector with defaults: `dom` enabled, `png` disabled, `both` available.",
      "Add style mode selector with defaults: `computed-lite`; allow `computed-full` only when explicitly requested.",
      "Add trigger settings with defaults: `click` and `manual`; keep `navigation` and `error` optional.",
      "Add PNG policy settings with recommended defaults (max images per session, max bytes per image, min capture interval).",
      "Implementation sequence (file-level): 1) apps/chrome-extension/src/capture-controls.ts, 2) apps/chrome-extension/src/popup.ts, 3) apps/chrome-extension/public/popup.html, 4) apps/chrome-extension/public/popup.css."
    ],
    "acceptance_criteria": [
      "Snapshots are disabled unless manual toggle and request conditions are satisfied.",
      "Default settings prioritize low risk and small payloads (DOM + computed-lite, click/manual triggers, PNG off).",
      "Users can override defaults safely from extension UI with validation and persistence."
    ],
    "passes": true,
    "id": "PRD-101",
    "depends_on": [],
    "estimate": "M"
  },
  {
    "category": "domain core",
    "description": "Capture timestamped UI snapshots in extension for DOM, CSS, and optional PNG",
    "owner": "extension",
    "priority": "high",
    "steps": [
      "Implement `CAPTURE_UI_SNAPSHOT` command flow reusing existing capture infrastructure for DOM and style extraction.",
      "Capture DOM snapshot payloads with byte limits and truncation markers to prevent oversized events.",
      "Capture computed styles for clicked element and ancestor chain in `computed-lite` mode; allow deeper mode only on explicit request.",
      "Add optional PNG capture path with strict throttle and per-session quota enforcement.",
      "Emit snapshot records with `timestamp`, `trigger`, `selector/url`, `mode`, and truncation metadata.",
      "Implementation sequence (file-level): 1) apps/chrome-extension/src/content-script.ts, 2) apps/chrome-extension/src/background.ts, 3) apps/chrome-extension/src/session-manager.ts, 4) apps/chrome-extension/src/injected-script.ts."
    ],
    "acceptance_criteria": [
      "Every stored snapshot has a precise timestamp and trigger context to support click -> snapshot flow analysis.",
      "DOM/CSS snapshots succeed under normal limits and degrade gracefully with truncation when limits are exceeded.",
      "PNG capture never bypasses configured throttles or byte/quantity limits."
    ],
    "passes": true,
    "id": "PRD-102",
    "depends_on": [
      "PRD-101"
    ],
    "estimate": "M"
  },
  {
    "category": "data/persistence",
    "description": "Persist snapshots in server storage with DB metadata and asset references",
    "owner": "backend-server",
    "priority": "high",
    "steps": [
      "Create `snapshots` table and indexes with migration support (session linkage, trigger linkage, mode, timestamps, truncation flags).",
      "Store DOM and style payloads as JSON text with size validation and explicit limit errors.",
      "Store PNG as asset files on disk and persist metadata/path references in SQLite instead of raw blobs.",
      "Add ingestion APIs for snapshot writes and snapshot list reads per session.",
      "Add retention integration to prune old snapshot rows and orphaned PNG assets safely.",
      "Implementation sequence (file-level): 1) apps/mcp-server/src/db/schema.ts, 2) apps/mcp-server/src/db/migrations.ts, 3) apps/mcp-server/src/main.ts, 4) apps/mcp-server/src/retention.ts."
    ],
    "acceptance_criteria": [
      "Server persists snapshot metadata and payloads with session and timestamp integrity.",
      "PNG assets are stored as files with valid references and are removed by retention when no longer needed.",
      "Snapshot APIs enforce payload limits and return deterministic validation errors."
    ],
    "passes": true,
    "id": "PRD-103",
    "depends_on": [
      "PRD-102"
    ],
    "estimate": "L"
  },
  {
    "category": "data/persistence",
    "description": "Support snapshot export/import with single-file packaging and compatibility mode",
    "owner": "backend-server",
    "priority": "medium",
    "steps": [
      "Extend export manifest to include snapshots with timestamped metadata and trigger context.",
      "Add single-file export format as `.zip` containing JSON manifest plus PNG assets.",
      "Keep JSON-only compatibility mode for DOM/CSS snapshots and optional base64 PNG embedding when explicitly requested.",
      "Extend import flow to restore snapshots and remap IDs while preserving time ordering.",
      "Add integrity checks for missing/corrupt assets and clear operator-facing errors.",
      "Implementation sequence (file-level): 1) apps/mcp-server/src/retention.ts, 2) apps/mcp-server/src/main.ts, 3) apps/chrome-extension/src/db-viewer.ts, 4) apps/chrome-extension/src/popup.ts."
    ],
    "acceptance_criteria": [
      "Single-file export/import round-trips snapshots without timestamp drift or broken references.",
      "Compatibility mode can produce JSON-only exports and optional base64 image payloads when requested.",
      "Export and import failures are explicit and actionable."
    ],
    "passes": true,
    "id": "PRD-104",
    "depends_on": [
      "PRD-103"
    ],
    "estimate": "L"
  },
  {
    "category": "MCP tools",
    "description": "Expose snapshot timeline and binary asset retrieval through MCP with safe limits",
    "owner": "backend-mcp",
    "priority": "high",
    "steps": [
      "Add MCP tools for snapshot discovery by session/time/trigger (`list_snapshots`, `get_snapshot_for_event`).",
      "Return metadata-first responses by default (no large binary payloads in standard queries).",
      "Add dedicated asset retrieval tool (`get_snapshot_asset`) supporting chunked reads and optional base64 encoding.",
      "Add strict maxBytes and pagination controls to avoid oversized MCP responses.",
      "Document tool contract for LLM workflows (POST ingest path vs MCP read path).",
      "Implementation sequence (file-level): 1) apps/mcp-server/src/mcp/server.ts, 2) libs/mcp-contracts/src, 3) apps/docs/docs/mcp-tools/."
    ],
    "acceptance_criteria": [
      "MCP can reconstruct click -> snapshot -> subsequent events using timestamps and trigger links.",
      "Binary asset retrieval is explicit, bounded, and does not destabilize normal tool responses.",
      "Contracts clearly separate ingestion APIs from MCP read APIs."
    ],
    "passes": true,
    "id": "PRD-105",
    "depends_on": [
      "PRD-103"
    ],
    "estimate": "M"
  },
  {
    "category": "domain utilities",
    "description": "Apply snapshot-specific privacy and redaction policy for DOM, CSS, and PNG",
    "owner": "security/privacy",
    "priority": "high",
    "steps": [
      "Define snapshot redaction policy extending safe mode with selector- and attribute-based masking.",
      "Mask or drop sensitive fields (password, payment, tokens, emails, input values) in DOM/style snapshots.",
      "Apply PNG privacy policy (skip/blur sensitive regions or block image capture under strict safe mode).",
      "Record redaction metadata in snapshot records for auditability.",
      "Add configuration switches for strict/standard profile with secure defaults.",
      "Implementation sequence (file-level): 1) apps/chrome-extension/src/capture-controls.ts, 2) apps/chrome-extension/src/content-script.ts, 3) apps/chrome-extension/src/injected-script.ts, 4) libs/redaction/src."
    ],
    "acceptance_criteria": [
      "Sensitive user data is not persisted in snapshots under default safe settings.",
      "Redaction behavior is deterministic and testable for DOM, CSS, and PNG paths.",
      "Each snapshot indicates whether redaction was applied and at what profile level."
    ],
    "passes": true,
    "id": "PRD-106",
    "depends_on": [
      "PRD-102",
      "PRD-103"
    ],
    "estimate": "M"
  },
  {
    "category": "testing/verification",
    "description": "Validate snapshot feature end-to-end with quotas, privacy, export, and MCP retrieval",
    "owner": "qa/backend",
    "priority": "high",
    "steps": [
      "Add unit tests for DOM/style snapshot generation, truncation, and redaction behavior.",
      "Add extension integration tests for trigger handling, throttling, and mode selection.",
      "Add server tests for snapshot APIs, migrations, retention cleanup, and asset lifecycle.",
      "Add export/import tests for zip package and JSON compatibility mode including base64 path.",
      "Add MCP tool tests for metadata queries and chunked asset retrieval.",
      "Implementation sequence (file-level): 1) apps/chrome-extension/src/*.spec.ts, 2) apps/mcp-server/src/main.spec.ts, 3) apps/mcp-server/src/retention.spec.ts, 4) apps/mcp-server/src/mcp/server.spec.ts, 5) docs/TROUBLESHOOTING.md."
    ],
    "acceptance_criteria": [
      "End-to-end flow confirms reliable click -> snapshot -> analysis timeline.",
      "Load tests show quotas/throttles prevent unbounded payload growth.",
      "Privacy tests prove snapshot redaction policy is enforced before persistence and export."
    ],
    "passes": true,
    "id": "PRD-107",
    "depends_on": [
      "PRD-104",
      "PRD-105",
      "PRD-106"
    ],
    "estimate": "L"
  }
]
